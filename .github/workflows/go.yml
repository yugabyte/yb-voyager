name: Go

on:
  push:
    branches: ['main', '*.*-dev', '*.*.*-dev']
  pull_request:
    branches: [main]

jobs:
  prepare-versions:
    uses: ./.github/workflows/prepare-versions.yml

  build-and-test:
    needs: [prepare-versions]
    runs-on: ubuntu-22.04
    env:
      YB_VOYAGER_SEND_DIAGNOSTICS: 0
    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ needs.prepare-versions.outputs.go_version }}

    - name: Build
      run: |
        cd yb-voyager
        go build -v ./...

    - name: Check for leaf errors using fmt.Errorf
      run: |
        # Leaf errors (without %w) should use goerrors.Errorf for stack traces.
        # Wrapped errors (with %w) should continue using fmt.Errorf.
        #
        # LIMITATION: This check is line-based and won't detect %w on a different
        # line than fmt.Errorf. Keep format strings on a single line to ensure
        # this check works correctly.
        #
        LEAF_ERRORS=$(grep -rn "fmt\.Errorf" yb-voyager/cmd yb-voyager/src --include="*.go" --exclude="*_test.go" | grep -v "%w" || true)
        if [[ -n "$LEAF_ERRORS" ]]; then
          echo "ERROR: Found fmt.Errorf used for leaf errors (without %w)."
          echo "Leaf errors should use goerrors.Errorf for stack traces."
          echo ""
          echo "Offending lines:"
          echo "$LEAF_ERRORS"
          echo ""
          echo "Fix: Replace 'fmt.Errorf(\"message\")' with 'goerrors.Errorf(\"message\")'"
          echo "Note: Wrapped errors using %w should continue using fmt.Errorf"
          exit 1
        fi
        echo "No leaf error violations found."

    - name: Verify Build Tags in Test Files
      run: |
        MISSING_TAGS=$(grep -L '//go:build' $(find . -type f -name '*_test.go' | grep -v vendor) || true)
        if [[ -n "$MISSING_TAGS" ]]; then
          echo "The following test files are missing a build tag: "
          echo "$MISSING_TAGS"
          echo "Ensure all test files have a build tag. If a new build tag is introduced, make sure to update the workflow to trigger the tests for that build tag."
          exit 1
        fi

    - name: Test
      run: |
        cd yb-voyager
        go test -v ./... -tags 'unit'
        
    - name: Vet
      run: |
        cd yb-voyager
        go vet ./...

    - name: Run staticcheck
      run: |
        cd yb-voyager
        go install honnef.co/go/tools/cmd/staticcheck@${{ needs.prepare-versions.outputs.staticcheck_version }}
        staticcheck ./...
