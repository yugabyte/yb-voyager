name: "Misc: Migration Tests"

on:
  push:
    branches: ['main', '*.*-dev', '*.*.*-dev']
  pull_request:
    branches: [main]

jobs:
  run-misc-migration-tests:
    runs-on: ubuntu-22.04
    
    env:
      YB_VOYAGER_SEND_DIAGNOSTICS: 0

    services:
        postgres:
          image: postgres:17
          env:
            POSTGRES_PASSWORD: postgres
          # Set health checks to wait until postgres has started
          options: >-
            --health-cmd pg_isready
            --health-interval 10s
            --health-timeout 5s
            --health-retries 5
          ports:
            # Maps tcp port 5432 on service container to the host
            - 5432:5432


    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        # https://github.com/actions/setup-java
        with:
          distribution: "temurin"
          java-version: "17"
          check-latest: true
      
      - name: Cache local Maven repository
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Free disk 
        run: df -h /

      - name: cleanup 
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          sudo docker builder prune -a

      - name: Free disk after cleanup
        run: df -h /


      - name: "Enable postgres with pg_stat_statements, pglogical loaded via shared_preload_libraries and install pg extensions"
        run: |
          docker exec ${{ job.services.postgres.id }} sh -c "
            apt-get update && apt-get install -y \
              postgresql-17-postgis-3 \
              postgresql-plpython3-17 \
              postgresql-plperl-17 \
              postgresql-17-pglogical"

          docker exec ${{ job.services.postgres.id }} sh -c "echo \"shared_preload_libraries = 'pg_stat_statements, pglogical'\" >> /var/lib/postgresql/data/postgresql.conf"

          docker restart ${{ job.services.postgres.id }}
          
          # Wait for PostgreSQL to be ready with health check instead of fixed sleep
          echo "Waiting for PostgreSQL to be ready after restart..."
          timeout 30s bash -c 'until docker exec ${{ job.services.postgres.id }} pg_isready > /dev/null 2>&1; do 
            echo "PostgreSQL not ready yet, waiting 1 second..."
            sleep 1
          done'
          echo "PostgreSQL is ready!"

      - name: Install python3, psycopg2 and bs4
        run: |
          sudo apt install -y python3
          sudo apt install -y libpq-dev
          sudo apt install python3-psycopg2
          pip3 install bs4 # Install BeautifulSoup4 module for HTML report validation

      - name: Run installer script to setup voyager
        run: |
          cd installer_scripts
          yes | ./install-yb-voyager --install-from-local-source --only-pg-support
          # Since pg_dump/restore 17 is required, we need to remove the symlink to the old PG 14 binary(default)
          # and create a symlink to the new PG 17 binary
          sudo rm /usr/bin/pg_dump
          sudo ln -s /usr/lib/postgresql/17/bin/pg_dump /usr/bin/pg_dump
          sudo rm /usr/bin/pg_restore
          sudo ln -s /usr/lib/postgresql/17/bin/pg_restore /usr/bin/pg_restore
          pg_dump --version
          pg_restore --version
          psql --version
        env:
          ON_INSTALLER_ERROR_OUTPUT_LOG: Y

      - name: Test PostgreSQL Connection
        run: |
          psql "postgresql://postgres:postgres@127.0.0.1:5432/postgres" -c "SELECT version();"

      - name: Create PostgreSQL user
        run: |
          ./migtests/scripts/postgresql/create_pg_user

      - name: "TEST: Basic assessment report test"
        run: migtests/scripts/run-validate-assessment-report.sh pg/basic-assessment-report-test

      - name: "TEST: Assessment Report Test For Performance optimization"
        run: migtests/scripts/run-validate-assessment-report.sh pg/assessment-perf-optimization-test

      - name: "TEST: Assessment Report Test"
        run: migtests/scripts/run-validate-assessment-report.sh pg/assessment-report-test

      - name: "TEST: Assessment Report Test with  2.25.0.0 target-db-version"
        run: migtests/scripts/run-validate-assessment-report.sh pg/assessment-report-test-with-tdb
      
      - name: "TEST: Assessment Report Test (Schema list UQC)"
        run: migtests/scripts/run-validate-assessment-report.sh pg/assessment-report-test-uqc

      - name: "TEST: analyze-schema"
        if: ${{ !cancelled() }}
        run: migtests/tests/analyze-schema/run-analyze-schema-test

      - name: Run import data file tests on different YugabyteDB versions
        env:
          GCS_CLIENT_ID: ${{ secrets.PGUPTA_GCS_CLIENT_ID }}
          GCS_CLIENT_SECRET: ${{ secrets.PGUPTA_GCS_CLIENT_SECRET }}
          GCS_REFRESH_TOKEN: ${{ secrets.PGUPTA_GCS_REFRESH_TOKEN }}
          AWS_ACCESS_KEY_ID: ${{ secrets.RAHULB_S3_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.RAHULB_S3_SECRET_ACCESS_KEY }}
        if: ${{ !cancelled() }}
        run: |
          versions=("2024.2.4.0-b89" "2.20.10.0-b29" "2.25.2.0-b359" "2025.1.0.0-b168" "2024.1.6.1-b2")
          for version in "${versions[@]}"; do
            echo "Running tests on version $version"

            echo "Start YugabyteDB cluster"
            docker run -d --name yugabytedb-$version --hostname yb-cluster-test-$version\
            -p7000:7000 -p9000:9000 -p15433:15433 -p5433:5433 -p9042:9042 \
            yugabytedb/yugabyte:$version \
            bin/yugabyted start --tserver_flags="ysql_hba_conf_csv={host all yugabyte all trust,host all all all md5}" --background=false --ui=false --callhome=false 
            
            # Wait for YugabyteDB to be ready with health check
            echo "Waiting for YugabyteDB to be ready..."
            timeout 60s bash -c 'until psql "postgresql://yugabyte:@127.0.0.1:5433/yugabyte" -c "SELECT 1" > /dev/null 2>&1; do 
              echo "YugabyteDB not ready yet, waiting 2 seconds..."
              sleep 2
            done'
            echo "YugabyteDB is ready!"
          
            echo "Test YugabyteDB connection"
            psql "postgresql://yugabyte:@127.0.0.1:5433/yugabyte" -c "SELECT version();"

            echo "Create YugabyteDB user"
            ./migtests/scripts/yugabytedb/create_yb_user

            echo "Enable yb-cluster-test-$version name resolution"
            docker_ip=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' yugabytedb-$version)
            echo "$docker_ip	yb-cluster-test-$version" | sudo tee -a /etc/hosts
            psql "postgresql://yugabyte@yb-cluster-test-$version:5433/yugabyte" -c "SELECT version();"

            echo "Setup the gcp credentials"
            migtests/scripts/gcs/create_gcs_credentials_file

            echo "TEST: import-data-file"
            migtests/tests/import-file/run-import-file-test

            echo "Stop the cluster before the next iteration"
            docker stop yugabytedb-$version
            docker remove yugabytedb-$version
          done
        shell: bash
